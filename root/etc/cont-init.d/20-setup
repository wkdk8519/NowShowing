#!/usr/bin/with-contenv sh

#Copies config files and creates advanced config file if not present
if [ -f /config/cfg/advanced.yaml ]; then
  echo "Advanced config file detected. Keeping existing files"
else
  # copy files incl advanced.yaml
  cp -Rp /opt/config/. /config/
  # set password to a random one
  php-cgi7 /opt/php/randomPass.php
fi

# Always load latest cron settings
ruby /usr/local/sbin/create-cron
# Always writes latest template variables on container startup to config.yaml
# not needed anymore - moved to web gui
# ruby /usr/local/sbin/config-setup

#fail2ban setup
# remove alpine default jail & copy in our jail settings and filter
rm /etc/fail2ban/jail.d/*
cp /opt/f2b/fail2ban.local /opt/f2b/jail.local /etc/fail2ban/
cp /opt/f2b/nowshowing.conf /etc/fail2ban/filter.d/
cp /opt/f2b/iptables-common.conf /etc/fail2ban/action.d/
fail2ban-client start

#read nowshowing_schedule.cron on container startup and add to crontab.
chown xyz:xyz /opt/nowshowing_schedule.cron
crontab -u xyz /opt/nowshowing_schedule.cron
crond

echo "Please go to http://hostServerIP:hostPort/admin to configure settings"
